name: EC2 ë°°í¬

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}

jobs:
  build-and-deploy:
    name: ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
      
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v2
      
    - name: ë°±ì—”ë“œ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        cd hospital_main
        echo "ğŸ”¨ ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build --no-cache -t hospital-backend:${{ github.sha }} .
        docker tag hospital-backend:${{ github.sha }} hospital-backend:latest
        echo "âœ… ë°±ì—”ë“œ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ"
        
    - name: ë„ì»¤ ì´ë¯¸ì§€ ì••ì¶• ë° ì €ì¥
      run: |
        echo "ğŸ’¾ Docker ì´ë¯¸ì§€ ì••ì¶• ì¤‘..."
        docker save hospital-backend:latest | gzip > backend.tar.gz
        
        # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
        ls -lh *.tar.gz
        echo "âœ… ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ"
        
    - name: ë°°í¬ íŒŒì¼ë“¤ì„ EC2 ì„œë²„ë¡œ ì „ì†¡
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "backend.tar.gz,docker-compose.prod.yml,deploy.sh"
        target: "/home/ec2-user/"
        
    - name: EC2 ì„œë²„ì— HTTPë¡œ ë°°í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        envs: GITHUB_SHA
        script: |
          echo "ğŸš€ ë³‘ì› í”„ë¡œì íŠ¸ HTTP ë°°í¬ ì‹œì‘..."
          
          # Docker ì´ë¯¸ì§€ ë¡œë“œ
          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
          docker load < /home/ec2-user/backend.tar.gz
          # docker load < /home/ec2-user/frontend.tar.gz # í”„ë¡ íŠ¸ì—”ë“œ ì›Œí¬í”Œë¡œìš°ê°€ ë³„ë„ë¡œ ìˆë‹¤ë©´ í•´ë‹¹ ë¼ì¸ ì œê±°
          
          # .env íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •)
          cat > .env << EOF
          ENVIRONMENT=production
          IMAGE_TAG=latest
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=3500
          
          # ë°±ì—”ë“œ ì„¤ì •
          BACKEND_HOST=hospital-backend
          BACKEND_PORT=8888
          
          # ë³‘ì›/ì•½êµ­ API í‚¤ ì„¤ì •
          HOSPITAL_MAIN_API_KEY=${{ secrets.HOSPITAL_MAIN_API_KEY }}
          HOSPITAL_DETAIL_API_KEY=${{ secrets.HOSPITAL_DETAIL_API_KEY }}
          HOSPITAL_MEDICAL_SUBJECT_API_KEY=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_KEY }}
          HOSPITAL_PRODOC_API_KEY=${{ secrets.HOSPITAL_PRODOC_API_KEY }}
          HOSPITAL_PHARMACY_API_KEY=${{ secrets.HOSPITAL_PHARMACY_API_KEY }}
          HOSPITAL_EMERGENCY_API_KEY=${{ secrets.HOSPITAL_EMERGENCY_API_KEY }}
          API_ADMIN_KEY=${{ secrets.API_ADMIN_KEY }}
          
          # ë³‘ì›/ì•½êµ­ API Base URL ì„¤ì •
          HOSPITAL_MAIN_API_BASE_URL=${{ secrets.HOSPITAL_MAIN_API_BASE_URL }}
          HOSPITAL_DETAIL_API_BASE_URL=${{ secrets.HOSPITAL_DETAIL_API_BASE_URL }}
          HOSPITAL_MEDICAL_SUBJECT_API_BASE_URL=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_BASE_URL }}
          HOSPITAL_PRODOC_API_BASE_URL=${{ secrets.HOSPITAL_PRODOC_API_BASE_URL }}
          HOSPITAL_PHARMACY_API_BASE_URL=${{ secrets.HOSPITAL_PHARMACY_API_BASE_URL }}
          HOSPITAL_EMERGENCY_API_BASE_URL=${{ secrets.HOSPITAL_EMERGENCY_API_BASE_URL }}
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
          DB_URL=${{ secrets.DB_URL }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          EOF
           
          # í™˜ê²½ë³€ìˆ˜ í™•ì¸
          echo "ğŸ“‹ ë°°í¬ í™˜ê²½ ì„¤ì •:"
          echo "  í™˜ê²½: ${{ secrets.ENVIRONMENT }}"
          echo "  ì ‘ì† ë°©ì‹: HTTP (IP ì§ì ‘ ì ‘ê·¼)"
          echo "  ë°±ì—”ë“œ í¬íŠ¸: 8888"
          echo "  í”„ë¡ íŠ¸ì—”ë“œ í¬íŠ¸: 80"
          echo "  DB í¬íŠ¸: 3500"
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x /home/ec2-user/deploy.sh
          
          # ë°°í¬ ì‹¤í–‰
          echo "â–¶ï¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
          /home/ec2-user/deploy.sh
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬..."
          rm -f /home/ec2-user/*.tar.gz
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          
    - name: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ë° í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "ğŸ¥ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker-compose -f /home/ec2-user/docker-compose.prod.yml ps
          
          # ë°±ì—”ë“œ API í™•ì¸ (í¬íŠ¸ 8888)
          TARGET_URL="http://${{ secrets.EC2_HOST }}:8888"
          echo "ğŸ” ë°±ì—”ë“œ API ì‘ë‹µ í…ŒìŠ¤íŠ¸ ($TARGET_URL)..."
          
          for i in {1..12}; do
            echo "  ì‹œë„ $i/12..."
            
            if curl -f -s --connect-timeout 10 "$TARGET_URL/" > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ API: ì •ìƒ"
              BACKEND_OK=true
              break
            else
              echo "â³ ë°±ì—”ë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
              sleep 10
            fi
          done
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
          if docker ps | grep hospital-db > /dev/null; then
            echo "âœ… ë°ì´í„°ë² ì´ìŠ¤: ì •ìƒ"
          else
            echo "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤: í™•ì¸ í•„ìš”"
          fi
          
          # ìµœì¢… ê²°ê³¼ ì¶œë ¥
          echo ""
          echo "ğŸ‰ =========================================="
          echo "    ë°±ì—”ë“œ ë°°í¬ ë° í—¬ìŠ¤ì²´í¬ ì™„ë£Œ!"
          echo "==========================================="
          echo ""
          echo "ğŸ“ ì ‘ì† ì •ë³´:"
          echo "  ğŸ”§ ë°±ì—”ë“œ API: http://${{ secrets.EC2_HOST }}:8888"
          echo "  ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤: í¬íŠ¸ 3500 (ë‚´ë¶€ ì ‘ê·¼)"
          echo ""
          echo "âœ¨ ë°±ì—”ë“œ ì„œë²„ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!"
