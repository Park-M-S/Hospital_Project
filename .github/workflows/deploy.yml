name: Deploy Hospital Project to EC2 (Self-Signed SSL)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: ë°±ì—”ë“œ ì´ë¯¸ì§€ ìƒì„±
      run: |
        cd hospital_main
        echo "ğŸ”¨ ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build --no-cache -t hospital-backend:${{ github.sha }} .
        docker tag hospital-backend:${{ github.sha }} hospital-backend:latest
        echo "âœ… ë°±ì—”ë“œ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ"
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ìƒì„± (Caddy + ìì²´ ì„œëª… SSL)
      run: |
        cd frontend
        echo "ğŸ”¨ í”„ë¡ íŠ¸ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘ (Caddy + SSL)..."
        
        # Vue.js í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (HTTPS ê¸°ë°˜)
        echo "VITE_API_BASE_URL=https://${{ secrets.EC2_HOST }}" > .env.production
        echo "VITE_GOOGLE_TTS_API_KEY=${{ secrets.VITE_GOOGLE_TTS_API_KEY }}" >> .env.production
        echo "VITE_KAKAO_REST_API_KEY=${{ secrets.VITE_KAKAO_REST_API_KEY }}" >> .env.production
        echo "VITE_KAKAO_MAP_KEY=${{ secrets.VITE_KAKAO_MAP_KEY }}" >> .env.production
        
        # ë¹Œë“œëœ í™˜ê²½ë³€ìˆ˜ í™•ì¸
        echo "ğŸ“‹ ìƒì„±ëœ í™˜ê²½ë³€ìˆ˜:"
        cat .env.production
        
        # Caddy ê¸°ë°˜ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ
        docker build -t hospital-frontend:${{ github.sha }} .
        docker tag hospital-frontend:${{ github.sha }} hospital-frontend:latest
        echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ (Caddy + SSL)"
        
    - name: ë„ì»¤ ì´ë¯¸ì§€ ì €ì¥
      run: |
        echo "ğŸ’¾ Docker ì´ë¯¸ì§€ ì••ì¶• ì¤‘..."
        docker save hospital-backend:latest | gzip > backend.tar.gz
        docker save hospital-frontend:latest | gzip > frontend.tar.gz
        
        # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
        ls -lh *.tar.gz
        echo "âœ… ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ"
        
    - name: ë°°í¬ íŒŒì¼ë“¤ EC2ì— ë³µì‚¬
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "backend.tar.gz,frontend.tar.gz,docker-compose.prod.yml,deploy.sh"
        target: "/home/ec2-user/"
        
    - name: Caddy ì„¤ì • íŒŒì¼ë“¤ ë³µì‚¬
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "frontend/Caddyfile.template,frontend/docker-entrypoint.sh"
        target: "/home/ec2-user/"
        strip_components: 1
        
    - name: Deploy to EC2 with Self-Signed SSL
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        envs: GITHUB_SHA
        script: |
          echo "ğŸš€ Hospital Project ìì²´ ì„œëª… SSL ë°°í¬ ì‹œì‘..."
          
          # Docker ì´ë¯¸ì§€ ë¡œë“œ
          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
          docker load < /home/ec2-user/backend.tar.gz
          docker load < /home/ec2-user/frontend.tar.gz
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (GitHub Secretsì—ì„œ ì „ë‹¬)
          export SERVER_IP="${{ secrets.EC2_HOST }}"
          export SERVER_DOMAIN=""
          export ADMIN_EMAIL="${{ secrets.ADMIN_EMAIL }}"
          export IMAGE_TAG="latest"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export DB_ROOT_PASSWORD="${{ secrets.DB_ROOT_PASSWORD }}"
          export BACKEND_PORT="${{ secrets.BACKEND_PORT }}"
          export DB_PORT="${{ secrets.DB_PORT }}"
          export ENVIRONMENT="${{ secrets.ENVIRONMENT }}"
          export CADDY_AUTO_HTTPS="on"
          
          # í™˜ê²½ë³€ìˆ˜ í™•ì¸
          echo "ğŸ“‹ ë°°í¬ í™˜ê²½ ì„¤ì •:"
          echo "  ì„œë²„ IP: $SERVER_IP"
          echo "  í™˜ê²½: $ENVIRONMENT"
          echo "  SSL íƒ€ì…: ìì²´ ì„œëª… ì¸ì¦ì„œ"
          echo "  ë°±ì—”ë“œ í¬íŠ¸: $BACKEND_PORT"
          echo "  DB í¬íŠ¸: $DB_PORT"
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x /home/ec2-user/deploy.sh
          
          # ë°°í¬ ì‹¤í–‰
          echo "â–¶ï¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
          /home/ec2-user/deploy.sh
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬..."
          rm -f /home/ec2-user/*.tar.gz
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          
    - name: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ë° í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "ğŸ¥ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker-compose -f /home/ec2-user/docker-compose.prod.yml ps
          
          # ì„œë¹„ìŠ¤ ì‘ë‹µ í™•ì¸ (ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°)
          echo "ğŸ” ì„œë¹„ìŠ¤ ì‘ë‹µ í…ŒìŠ¤íŠ¸..."
          
          for i in {1..12}; do
            echo "  ì‹œë„ $i/12..."
            
            # HTTPS í”„ë¡ íŠ¸ì—”ë“œ í™•ì¸ (ìì²´ ì„œëª… ì¸ì¦ì„œ)
            if curl -f -s -k --connect-timeout 5 "https://${{ secrets.EC2_HOST }}" > /dev/null 2>&1; then
              echo "âœ… HTTPS í”„ë¡ íŠ¸ì—”ë“œ: ì •ìƒ"
              FRONTEND_OK=true
              break
            elif curl -f -s --connect-timeout 5 "http://${{ secrets.EC2_HOST }}" > /dev/null 2>&1; then
              echo "âœ… HTTP í”„ë¡ íŠ¸ì—”ë“œ: ì •ìƒ (HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸)"
              FRONTEND_OK=true
              break
            else
              echo "â³ í”„ë¡ íŠ¸ì—”ë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
              sleep 5
            fi
          done
          
          # ë°±ì—”ë“œ API í™•ì¸
          for i in {1..6}; do
            if curl -f -s --connect-timeout 5 "http://${{ secrets.EC2_HOST }}:${{ secrets.BACKEND_PORT }}" > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ API: ì •ìƒ"
              BACKEND_OK=true
              break
            else
              echo "â³ ë°±ì—”ë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/6)"
              sleep 10
            fi
          done
          
          # ìµœì¢… ê²°ê³¼ ì¶œë ¥
          echo ""
          echo "ğŸ‰ =========================================="
          echo "    ë°°í¬ ë° í—¬ìŠ¤ì²´í¬ ì™„ë£Œ!"
          echo "==========================================="
          echo ""
          echo "ğŸ“ ì ‘ì† ì •ë³´:"
          echo "  ğŸ”’ HTTPS: https://${{ secrets.EC2_HOST }} (ìì²´ ì„œëª… ì¸ì¦ì„œ)"
          echo "  ğŸŒ HTTP:  http://${{ secrets.EC2_HOST }} (HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸)"
          echo "  ğŸ”§ Backend API: http://${{ secrets.EC2_HOST }}:${{ secrets.BACKEND_PORT }}"
          echo ""
          echo "ğŸ” ë¸Œë¼ìš°ì € ì ‘ì† ë°©ë²•:"
          echo "  1. https://${{ secrets.EC2_HOST }} ì ‘ì†"
          echo "  2. ë³´ì•ˆ ê²½ê³ ì—ì„œ 'ê³ ê¸‰' â†’ 'ì•ˆì „í•˜ì§€ ì•ŠìŒì„ ìŠ¹ì¸í•˜ê³  ê³„ì†'"
          echo ""
          echo "âœ¨ Geolocation APIê°€ HTTPS í™˜ê²½ì—ì„œ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!"
          
          # ë¡œê·¸ í™•ì¸ (ì—ëŸ¬ê°€ ìˆëŠ” ê²½ìš°)
          if docker-compose -f /home/ec2-user/docker-compose.prod.yml logs --tail=10 | grep -i error > /dev/null 2>&1; then
            echo ""
            echo "âš ï¸ ì¼ë¶€ ì„œë¹„ìŠ¤ì—ì„œ ì—ëŸ¬ ë°œê²¬:"
            docker-compose -f /home/ec2-user/docker-compose.prod.yml logs --tail=20 | grep -i error
          fi
          
    - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
      if: failure()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨! ë¡¤ë°± ì‹œë„..."
          
          # ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          docker-compose -f /home/ec2-user/docker-compose.prod.yml down || true
          
          # ìµœê·¼ ë¡œê·¸ í™•ì¸
          echo "ğŸ“ ìµœê·¼ ë¡œê·¸:"
          docker-compose -f /home/ec2-user/docker-compose.prod.yml logs --tail=50
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /home/ec2-user/*.tar.gz
          
          echo "ğŸ”„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
