name: EC2 ë°°í¬ (DuckDNS) 

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}

jobs:
  build-and-deploy:
    name: ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
      
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v2
      
    - name: ë°±ì—”ë“œ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        cd hospital_main
        echo "ğŸ”¨ ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build --no-cache -t hospital-backend:${{ github.sha }} .
        docker tag hospital-backend:${{ github.sha }} hospital-backend:latest
        echo "âœ… ë°±ì—”ë“œ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ"
        
    - name: ë„ì»¤ ì´ë¯¸ì§€ ì••ì¶• ë° ì €ì¥
      run: |
        echo "ğŸ’¾ Docker ì´ë¯¸ì§€ ì••ì¶• ì¤‘..."
        docker save hospital-backend:latest | gzip > backend.tar.gz
        
        # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
        ls -lh *.tar.gz
        echo "âœ… ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ"
        
    - name: ë°°í¬ íŒŒì¼ë“¤ì„ EC2 ì„œë²„ë¡œ ì „ì†¡
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "backend.tar.gz,docker-compose.prod.yml,deploy.sh"
        target: "/home/ec2-user/"

    - name: EC2 ì„œë²„ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ (í”„ë¡œë•ì…˜)
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "ğŸ”„ í”„ë¡œë•ì…˜ ì„œë²„ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ ì‹œì‘..."
          
          # ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
          echo "ğŸ“¦ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ì¤‘..."
          sudo yum update -y
          
          # ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          sudo yum install -y wget curl git unzip htop
          
          # Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v docker &> /dev/null; then
            echo "ğŸ³ Docker ì„¤ì¹˜ ì¤‘..."
            sudo yum install -y docker
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -a -G docker ec2-user
            echo "âœ… Docker ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âœ… Docker ì´ë¯¸ ì„¤ì¹˜ë¨"
            docker --version
          fi
          
          # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v docker-compose &> /dev/null; then
            echo "ğŸ”§ Docker Compose ì„¤ì¹˜ ì¤‘..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
            echo "âœ… Docker Compose ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âœ… Docker Compose ì´ë¯¸ ì„¤ì¹˜ë¨"
            docker-compose --version
          fi
          
          # í”„ë¡œë•ì…˜ ëª¨ë‹ˆí„°ë§ ë„êµ¬ ë””ë ‰í† ë¦¬ ìƒì„±
          sudo mkdir -p /opt/monitoring/{grafana,prometheus,loki}
          sudo chown -R ec2-user:ec2-user /opt/monitoring/
          
          # Grafana ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜ (í”„ë¡œë•ì…˜)
          if ! systemctl is-active --quiet grafana-server; then
            echo "ğŸ“Š Grafana ì„¤ì¹˜ ì¤‘... (í”„ë¡œë•ì…˜)"
            sudo yum install -y https://dl.grafana.com/oss/release/grafana-10.2.2-1.x86_64.rpm
            sudo systemctl daemon-reload
            sudo systemctl enable grafana-server
            sudo systemctl start grafana-server
            
            # Grafana ë³´ì•ˆ ì„¤ì • (í”„ë¡œë•ì…˜ìš©)
            sudo mkdir -p /etc/grafana/provisioning/dashboards
            sudo mkdir -p /etc/grafana/provisioning/datasources
            
            echo "âœ… Grafana ì„¤ì¹˜ ì™„ë£Œ (í¬íŠ¸: 3000)"
          else
            echo "âœ… Grafana ì´ë¯¸ ì‹¤í–‰ ì¤‘"
          fi
          
          # Prometheus ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜ (í”„ë¡œë•ì…˜)
          if [ ! -d "/opt/prometheus" ]; then
            echo "ğŸ“ˆ Prometheus ì„¤ì¹˜ ì¤‘... (í”„ë¡œë•ì…˜)"
            cd /tmp
            wget https://github.com/prometheus/prometheus/releases/download/v2.47.2/prometheus-2.47.2.linux-amd64.tar.gz
            tar xvfz prometheus-*.tar.gz
            sudo mv prometheus-2.47.2.linux-amd64 /opt/prometheus
            sudo chown -R ec2-user:ec2-user /opt/prometheus
            
            # Prometheus í”„ë¡œë•ì…˜ ì„¤ì • íŒŒì¼ ìƒì„±
            cat > /opt/prometheus/prometheus.yml << EOF
          global:
            scrape_interval: 15s
            evaluation_interval: 15s
            external_labels:
              environment: 'production'
              cluster: 'hospital-main'
          
          rule_files:
            # - "alert_rules.yml"
          
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
              scrape_interval: 30s
            
            - job_name: 'hospital-backend-prod'
              static_configs:
                - targets: ['localhost:8888']
              metrics_path: '/actuator/prometheus'
              scrape_interval: 10s
              scrape_timeout: 10s
            
            - job_name: 'hospital-mariadb'
              static_configs:
                - targets: ['localhost:3500']
              scrape_interval: 30s
          
            - job_name: 'node-exporter'
              static_configs:
                - targets: ['localhost:9100']
              scrape_interval: 15s
          EOF
            
            # Prometheus í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
            sudo tee /etc/systemd/system/prometheus.service > /dev/null << EOF
          [Unit]
          Description=Prometheus Server (Production)
          Documentation=https://prometheus.io/docs/
          After=network-online.target
          
          [Service]
          User=ec2-user
          Restart=on-failure
          RestartSec=5
          ExecStart=/opt/prometheus/prometheus \\
            --config.file=/opt/prometheus/prometheus.yml \\
            --storage.tsdb.path=/opt/prometheus/data \\
            --storage.tsdb.retention.time=30d \\
            --web.console.templates=/opt/prometheus/consoles \\
            --web.console.libraries=/opt/prometheus/console_libraries \\
            --web.listen-address=0.0.0.0:9090 \\
            --web.enable-lifecycle \\
            --web.enable-admin-api
          
          [Install]
          WantedBy=multi-user.target
          EOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable prometheus
            sudo systemctl start prometheus
            echo "âœ… Prometheus ì„¤ì¹˜ ì™„ë£Œ (í¬íŠ¸: 9090)"
          else
            echo "âœ… Prometheus ì´ë¯¸ ì„¤ì¹˜ë¨"
          fi
          
          # Loki ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜ (í”„ë¡œë•ì…˜)
          if [ ! -d "/opt/loki" ]; then
            echo "ğŸ“‹ Loki ì„¤ì¹˜ ì¤‘... (í”„ë¡œë•ì…˜)"
            cd /tmp
            wget https://github.com/grafana/loki/releases/download/v2.9.2/loki-linux-amd64.zip
            unzip loki-linux-amd64.zip
            sudo mkdir -p /opt/loki/{data,chunks,rules}
            sudo mv loki-linux-amd64 /opt/loki/loki
            sudo chmod +x /opt/loki/loki
            sudo chown -R ec2-user:ec2-user /opt/loki
            
            # Loki í”„ë¡œë•ì…˜ ì„¤ì • íŒŒì¼ ìƒì„±
            cat > /opt/loki/loki-local-config.yaml << EOF
          auth_enabled: false
          
          server:
            http_listen_port: 3100
            grpc_listen_port: 9096
            log_level: info
          
          common:
            path_prefix: /opt/loki
            storage:
              filesystem:
                chunks_directory: /opt/loki/chunks
                rules_directory: /opt/loki/rules
            replication_factor: 1
            ring:
              instance_addr: 127.0.0.1
              kvstore:
                store: inmemory
          
          query_range:
            results_cache:
              cache:
                embedded_cache:
                  enabled: true
                  max_size_mb: 500
          
          schema_config:
            configs:
              - from: 2020-10-24
                store: boltdb-shipper
                object_store: filesystem
                schema: v11
                index:
                  prefix: index_
                  period: 24h
          
          limits_config:
            retention_period: 30d
            max_query_series: 100000
            max_query_parallelism: 32
          
          table_manager:
            retention_deletes_enabled: true
            retention_period: 30d
          
          ruler:
            alertmanager_url: http://localhost:9093
          EOF
            
            # Loki í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
            sudo tee /etc/systemd/system/loki.service > /dev/null << EOF
          [Unit]
          Description=Loki service (Production)
          After=network.target
          
          [Service]
          Type=simple
          User=ec2-user
          ExecStart=/opt/loki/loki -config.file /opt/loki/loki-local-config.yaml
          Restart=on-failure
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=loki
          
          [Install]
          WantedBy=multi-user.target
          EOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable loki
            sudo systemctl start loki
            echo "âœ… Loki ì„¤ì¹˜ ì™„ë£Œ (í¬íŠ¸: 3100)"
          else
            echo "âœ… Loki ì´ë¯¸ ì„¤ì¹˜ë¨"
          fi
          
          # Promtail ì„¤ì¹˜ (í”„ë¡œë•ì…˜ ë¡œê·¸ ìˆ˜ì§‘)
          if [ ! -f "/opt/loki/promtail" ]; then
            echo "ğŸ“¤ Promtail ì„¤ì¹˜ ì¤‘... (í”„ë¡œë•ì…˜)"
            cd /tmp
            wget https://github.com/grafana/loki/releases/download/v2.9.2/promtail-linux-amd64.zip
            unzip promtail-linux-amd64.zip
            sudo mv promtail-linux-amd64 /opt/loki/promtail
            sudo chmod +x /opt/loki/promtail
            
            # Promtail í”„ë¡œë•ì…˜ ì„¤ì • íŒŒì¼ ìƒì„±
            cat > /opt/loki/promtail-local-config.yaml << EOF
          server:
            http_listen_port: 9080
            grpc_listen_port: 0
          
          positions:
            filename: /opt/loki/positions.yaml
          
          clients:
            - url: http://localhost:3100/loki/api/v1/push
          
          scrape_configs:
            - job_name: system-logs
              static_configs:
                - targets:
                    - localhost
                  labels:
                    job: system
                    environment: production
                    __path__: /var/log/*log
            
            - job_name: docker-logs
              static_configs:
                - targets:
                    - localhost
                  labels:
                    job: docker
                    environment: production
                    __path__: /var/lib/docker/containers/*/*log
            
            - job_name: hospital-app-logs
              static_configs:
                - targets:
                    - localhost
                  labels:
                    job: hospital-backend
                    environment: production
                    __path__: /opt/hospital/logs/*.log
          EOF
            
            # Promtail í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
            sudo tee /etc/systemd/system/promtail.service > /dev/null << EOF
          [Unit]
          Description=Promtail service (Production)
          After=network.target
          
          [Service]
          Type=simple
          User=ec2-user
          ExecStart=/opt/loki/promtail -config.file /opt/loki/promtail-local-config.yaml
          Restart=on-failure
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=promtail
          
          [Install]
          WantedBy=multi-user.target
          EOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable promtail
            sudo systemctl start promtail
            echo "âœ… Promtail ì„¤ì¹˜ ì™„ë£Œ (í¬íŠ¸: 9080)"
          fi
          
          # Node Exporter ì„¤ì¹˜ (ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘)
          if [ ! -f "/opt/node_exporter/node_exporter" ]; then
            echo "ğŸ–¥ï¸ Node Exporter ì„¤ì¹˜ ì¤‘... (í”„ë¡œë•ì…˜)"
            cd /tmp
            wget https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz
            tar xvfz node_exporter-*.tar.gz
            sudo mkdir -p /opt/node_exporter
            sudo mv node_exporter-1.6.1.linux-amd64/node_exporter /opt/node_exporter/
            sudo chmod +x /opt/node_exporter/node_exporter
            sudo chown -R ec2-user:ec2-user /opt/node_exporter
            
            # Node Exporter ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
            sudo tee /etc/systemd/system/node_exporter.service > /dev/null << EOF
          [Unit]
          Description=Node Exporter
          After=network.target
          
          [Service]
          Type=simple
          User=ec2-user
          ExecStart=/opt/node_exporter/node_exporter --web.listen-address=:9100
          Restart=on-failure
          RestartSec=5
          
          [Install]
          WantedBy=multi-user.target
          EOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable node_exporter
            sudo systemctl start node_exporter
            echo "âœ… Node Exporter ì„¤ì¹˜ ì™„ë£Œ (í¬íŠ¸: 9100)"
          fi
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ğŸ” í”„ë¡œë•ì…˜ ì„œë²„ ì„¤ì¹˜ëœ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
          echo "  Docker: $(sudo systemctl is-active docker)"
          echo "  Grafana: $(sudo systemctl is-active grafana-server)"
          echo "  Prometheus: $(sudo systemctl is-active prometheus)"
          echo "  Loki: $(sudo systemctl is-active loki)"
          echo "  Promtail: $(sudo systemctl is-active promtail)"
          echo "  Node Exporter: $(sudo systemctl is-active node_exporter)"
          
          echo "âœ… í”„ë¡œë•ì…˜ ì„œë²„ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° ëª¨ë‹ˆí„°ë§ ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ!"
        
    - name: EC2 ì„œë²„ì— DuckDNSë¡œ ë°°í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        envs: GITHUB_SHA
        script: |
          echo "ğŸš€ ë³‘ì› í”„ë¡œì íŠ¸ DuckDNS ë°°í¬ ì‹œì‘..."
          
          # Docker ì´ë¯¸ì§€ ë¡œë“œ
          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
          docker load < /home/ec2-user/backend.tar.gz
          
          # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
          sudo mkdir -p /opt/hospital/config/duckdns
          sudo mkdir -p /opt/hospital/logs
          sudo chown -R ec2-user:ec2-user /opt/hospital/
          
          # .env íŒŒì¼ ìƒì„±
          cat > .env << EOF
          ENVIRONMENT=production
          IMAGE_TAG=latest
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=3500
          
          # ë°±ì—”ë“œ ì„¤ì •
          BACKEND_HOST=hospital-backend
          BACKEND_PORT=8888
          
          # DuckDNS ì„¤ì •
          DUCKDNS_DOMAIN=${{ secrets.DUCKDNS_DOMAIN }}
          DUCKDNS_SUBDOMAIN=${{ secrets.DUCKDNS_SUBDOMAIN }}
          DUCKDNS_TOKEN=${{ secrets.DUCKDNS_TOKEN }}
          
          # ë³‘ì›/ì•½êµ­ API í‚¤ ì„¤ì •
          HOSPITAL_MAIN_API_KEY=${{ secrets.HOSPITAL_MAIN_API_KEY }}
          HOSPITAL_DETAIL_API_KEY=${{ secrets.HOSPITAL_DETAIL_API_KEY }}
          HOSPITAL_MEDICAL_SUBJECT_API_KEY=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_KEY }}
          HOSPITAL_PRODOC_API_KEY=${{ secrets.HOSPITAL_PRODOC_API_KEY }}
          HOSPITAL_PHARMACY_API_KEY=${{ secrets.HOSPITAL_PHARMACY_API_KEY }}
          HOSPITAL_EMERGENCY_API_KEY=${{ secrets.HOSPITAL_EMERGENCY_API_KEY }}
          API_ADMIN_KEY=${{ secrets.API_ADMIN_KEY }}
          
          # ë³‘ì›/ì•½êµ­ API Base URL ì„¤ì •
          HOSPITAL_MAIN_API_BASE_URL=${{ secrets.HOSPITAL_MAIN_API_BASE_URL }}
          HOSPITAL_DETAIL_API_BASE_URL=${{ secrets.HOSPITAL_DETAIL_API_BASE_URL }}
          HOSPITAL_MEDICAL_SUBJECT_API_BASE_URL=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_BASE_URL }}
          HOSPITAL_PRODOC_API_BASE_URL=${{ secrets.HOSPITAL_PRODOC_API_BASE_URL }}
          HOSPITAL_PHARMACY_API_BASE_URL=${{ secrets.HOSPITAL_PHARMACY_API_BASE_URL }}
          HOSPITAL_EMERGENCY_API_BASE_URL=${{ secrets.HOSPITAL_EMERGENCY_API_BASE_URL }}
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
          DB_URL=${{ secrets.DB_URL }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          EOF
           
          # í™˜ê²½ë³€ìˆ˜ í™•ì¸
          echo "ğŸ“‹ ë°°í¬ í™˜ê²½ ì„¤ì •:"
          echo "  í™˜ê²½: production"
          echo "  DuckDNS ë„ë©”ì¸: ${{ secrets.DUCKDNS_DOMAIN }}"
          echo "  DuckDNS ì„œë¸Œë„ë©”ì¸: ${{ secrets.DUCKDNS_SUBDOMAIN }}"
          echo "  ë°±ì—”ë“œ í¬íŠ¸: 8888"
          echo "  DB í¬íŠ¸: 3500"
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x /home/ec2-user/deploy.sh
          
          # ë°°í¬ ì‹¤í–‰
          echo "â–¶ï¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
          /home/ec2-user/deploy.sh
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬..."
          rm -f /home/ec2-user/*.tar.gz
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          
    - name: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ë° í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "ğŸ¥ í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker-compose -f /home/ec2-user/docker-compose.prod.yml ps
          
          # ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ğŸ“ˆ ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ ìƒíƒœ:"
          echo "  Grafana: $(sudo systemctl is-active grafana-server) - http://localhost:3000"
          echo "  Prometheus: $(sudo systemctl is-active prometheus) - http://localhost:9090"
          echo "  Loki: $(sudo systemctl is-active loki) - http://localhost:3100"
          echo "  Promtail: $(sudo systemctl is-active promtail) - http://localhost:9080"
          echo "  Node Exporter: $(sudo systemctl is-active node_exporter) - http://localhost:9100"
          
          # DuckDNS ë„ë©”ì¸ìœ¼ë¡œ ë°±ì—”ë“œ API í™•ì¸
          TARGET_URL="http://${{ secrets.DUCKDNS_DOMAIN }}:8888"
          echo "ğŸ” ë°±ì—”ë“œ API ì‘ë‹µ í…ŒìŠ¤íŠ¸ ($TARGET_URL)..."
          
          for i in {1..12}; do
            echo "  ì‹œë„ $i/12..."
            
            if curl -f -s --connect-timeout 10 "$TARGET_URL/api/proDoc/status" > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ API: ì •ìƒ"
              BACKEND_OK=true
              break
            else
              echo "â³ ë°±ì—”ë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
              sleep 10
            fi
          done
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
          if docker ps | grep hospital-mariadb > /dev/null; then
            echo "âœ… ë°ì´í„°ë² ì´ìŠ¤: ì •ìƒ"
          else
            echo "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤: í™•ì¸ í•„ìš”"
          fi
          
          # DuckDNS ì»¨í…Œì´ë„ˆ í™•ì¸
          if docker ps | grep hospital-duckdns > /dev/null; then
            echo "âœ… DuckDNS ìë™ ì—…ë°ì´íŠ¸: í™œì„±í™”"
            docker logs hospital-duckdns --tail=5
          else
            echo "âš ï¸ DuckDNS ìë™ ì—…ë°ì´íŠ¸: ë¹„í™œì„±í™”"
          fi
          
          # ìµœì¢… ê²°ê³¼ ì¶œë ¥
          echo ""
          echo "ğŸ‰ =========================================="
          echo "    í”„ë¡œë•ì…˜ ë°°í¬ ë° í—¬ìŠ¤ì²´í¬ ì™„ë£Œ!"
          echo "==========================================="
          echo ""
          echo "ğŸ“ ì ‘ì† ì •ë³´:"
          echo "  ğŸ”§ ë°±ì—”ë“œ API: http://${{ secrets.DUCKDNS_DOMAIN }}:8888"
          echo "  ğŸŒ DuckDNS ë„ë©”ì¸: ${{ secrets.DUCKDNS_DOMAIN }}"
          echo "  ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤: í¬íŠ¸ 3500 (ë‚´ë¶€ ì ‘ê·¼)"
          echo ""
          echo "ğŸ“ˆ í”„ë¡œë•ì…˜ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ:"
          echo "  ğŸ“Š Grafana: http://${{ secrets.DUCKDNS_DOMAIN }}:3000 (admin/ì»¤ìŠ¤í…€ë¹„ë°€ë²ˆí˜¸)"
          echo "  ğŸ“ˆ Prometheus: http://${{ secrets.DUCKDNS_DOMAIN }}:9090"
          echo "  ğŸ“‹ Loki: http://${{ secrets.DUCKDNS_DOMAIN }}:3100"
          echo "  ğŸ–¥ï¸ Node Exporter: http://${{ secrets.DUCKDNS_DOMAIN }}:9100/metrics"
          echo ""
          echo "ğŸ”§ API í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ:"
          echo "  curl http://${{ secrets.DUCKDNS_DOMAIN }}:8888/api/proDoc/status"
          echo "  curl http://${{ secrets.DUCKDNS_DOMAIN }}:8888/api/list"
          echo ""
          echo "ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½ DuckDNS ìë™ IP ì—…ë°ì´íŠ¸ ë° ëª¨ë‹ˆí„°ë§ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!"
          
    - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì²˜ë¦¬
      if: failure()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "âŒ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨! ë¡¤ë°± ì‹œë„..."
          
          # ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          docker-compose -f /home/ec2-user/docker-compose.prod.yml down || true
          
          # ìµœê·¼ ë¡œê·¸ í™•ì¸
          echo "ğŸ“ ìµœê·¼ ë¡œê·¸:"
          docker-compose -f /home/ec2-user/docker-compose.prod.yml logs --tail=50
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /home/ec2-user/*.tar.gz
          
          echo "ğŸ”„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
