name: ë³‘ì› í”„ë¡œì íŠ¸ EC2 ë°°í¬ (DuckDNS SSL)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}

jobs:
  build-and-deploy:
    name: ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
      
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v2
      
    - name: ë°±ì—”ë“œ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        cd hospital_main
        echo "ğŸ”¨ ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build --no-cache -t hospital-backend:${{ github.sha }} .
        docker tag hospital-backend:${{ github.sha }} hospital-backend:latest
        echo "âœ… ë°±ì—”ë“œ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ"
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ (Caddy + DuckDNS SSL)
      run: |
        cd frontend
        echo "ğŸ”¨ í”„ë¡ íŠ¸ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘ (Caddy + DuckDNS SSL)..."
        
        # Vue.js í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (DuckDNS ë„ë©”ì¸ ê¸°ë°˜)
        echo "VITE_API_BASE_URL=https://${{ secrets.DUCKDNS_DOMAIN }}" > .env.production
        echo "VITE_GOOGLE_TTS_API_KEY=${{ secrets.VITE_GOOGLE_TTS_API_KEY }}" >> .env.production
        echo "VITE_KAKAO_REST_API_KEY=${{ secrets.VITE_KAKAO_REST_API_KEY }}" >> .env.production
        echo "VITE_KAKAO_MAP_KEY=${{ secrets.VITE_KAKAO_MAP_KEY }}" >> .env.production
        
        # ë¹Œë“œëœ í™˜ê²½ë³€ìˆ˜ í™•ì¸
        echo "ğŸ“‹ ìƒì„±ëœ í™˜ê²½ë³€ìˆ˜:"
        cat .env.production
        
        # Caddy ê¸°ë°˜ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ
        docker build -t hospital-frontend:${{ github.sha }} .
        docker tag hospital-frontend:${{ github.sha }} hospital-frontend:latest
        echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ (Caddy + DuckDNS SSL)"
        
    - name: ë„ì»¤ ì´ë¯¸ì§€ ì••ì¶• ë° ì €ì¥
      run: |
        echo "ğŸ’¾ Docker ì´ë¯¸ì§€ ì••ì¶• ì¤‘..."
        docker save hospital-backend:latest | gzip > backend.tar.gz
        docker save hospital-frontend:latest | gzip > frontend.tar.gz
        
        # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
        ls -lh *.tar.gz
        echo "âœ… ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ"
        
    - name: ë°°í¬ íŒŒì¼ë“¤ì„ EC2 ì„œë²„ë¡œ ì „ì†¡
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "backend.tar.gz,frontend.tar.gz,docker-compose.prod.yml,deploy.sh"
        target: "/home/ec2-user/"
        
    - name: Caddy ì„¤ì • íŒŒì¼ë“¤ì„ EC2 ì„œë²„ë¡œ ì „ì†¡
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "frontend/Caddyfile.template,frontend/docker-entrypoint.sh"
        target: "/home/ec2-user/"
        strip_components: 1
        
    - name: EC2 ì„œë²„ì— DuckDNS SSLë¡œ ë°°í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        envs: GITHUB_SHA
        script: |
          echo "ğŸš€ ë³‘ì› í”„ë¡œì íŠ¸ DuckDNS SSL ë°°í¬ ì‹œì‘..."
          
          # Docker ì´ë¯¸ì§€ ë¡œë“œ
          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
          docker load < /home/ec2-user/backend.tar.gz
          docker load < /home/ec2-user/frontend.tar.gz
          
          # .env íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •)
          cat > .env << EOF
          ENVIRONMENT=production
          IMAGE_TAG=latest
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=3500
          
          # ë°±ì—”ë“œ ì„¤ì •
          BACKEND_HOST=hospital-backend
          BACKEND_PORT=8888
          
          # DuckDNS ì„¤ì •
          DUCKDNS_DOMAIN=${{ secrets.DUCKDNS_DOMAIN }}
          DUCKDNS_SUBDOMAIN=${{ secrets.DUCKDNS_SUBDOMAIN }}
          DUCKDNS_TOKEN=${{ secrets.DUCKDNS_TOKEN }}
          ACME_EMAIL=${{ secrets.ACME_EMAIL }}
          
          # ë³‘ì›/ì•½êµ­ API í‚¤ ì„¤ì •
          HOSPITAL_MAIN_API_KEY=${{ secrets.HOSPITAL_MAIN_API_KEY }}
          HOSPITAL_DETAIL_API_KEY=${{ secrets.HOSPITAL_DETAIL_API_KEY }}
          HOSPITAL_MEDICAL_SUBJECT_API_KEY=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_KEY }}
          HOSPITAL_PRODOC_API_KEY=${{ secrets.HOSPITAL_PRODOC_API_KEY }}
          HOSPITAL_PHARMACY_API_KEY=${{ secrets.HOSPITAL_PHARMACY_API_KEY }}
          HOSPITAL_EMERGENCY_API_KEY=${{ secrets.HOSPITAL_EMERGENCY_API_KEY }}
          EOF
          
          # í™˜ê²½ë³€ìˆ˜ í™•ì¸
          echo "ğŸ“‹ ë°°í¬ í™˜ê²½ ì„¤ì •:"
          echo "  í™˜ê²½: ${{ secrets.ENVIRONMENT }}"
          echo "  DuckDNS ë„ë©”ì¸: ${{ secrets.DUCKDNS_DOMAIN }}"
          echo "  SSL íƒ€ì…: Let's Encrypt (DuckDNS)"
          echo "  ë°±ì—”ë“œ í¬íŠ¸: 8888"
          echo "  DB í¬íŠ¸: 3500"
          
          # DuckDNS ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ./duckdns
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x /home/ec2-user/deploy.sh
          
          # ë°°í¬ ì‹¤í–‰
          echo "â–¶ï¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
          /home/ec2-user/deploy.sh
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬..."
          rm -f /home/ec2-user/*.tar.gz
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          
    - name: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ë° í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "ğŸ¥ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker-compose -f /home/ec2-user/docker-compose.prod.yml ps
          
          # DuckDNS ë„ë©”ì¸ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
          TARGET_URL="https://${{ secrets.DUCKDNS_DOMAIN }}"
          echo "ğŸ” DuckDNS SSL ì„œë¹„ìŠ¤ ì‘ë‹µ í…ŒìŠ¤íŠ¸ ($TARGET_URL)..."
          
          # ì„œë¹„ìŠ¤ ì‘ë‹µ í™•ì¸ (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸° - SSL ì¸ì¦ì„œ ë°œê¸‰ ì‹œê°„ ê³ ë ¤)
          for i in {1..24}; do
            echo "  ì‹œë„ $i/24..."
            
            if curl -f -s -k --connect-timeout 10 "$TARGET_URL" > /dev/null 2>&1; then
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ: ì •ìƒ"
              FRONTEND_OK=true
              break
            else
              echo "â³ í”„ë¡ íŠ¸ì—”ë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘... (SSL ì¸ì¦ì„œ ë°œê¸‰ ëŒ€ê¸° í¬í•¨)"
              sleep 5
            fi
          done
          
          # ë°±ì—”ë“œ API í™•ì¸
          for i in {1..6}; do
            if curl -f -s --connect-timeout 5 "http://${{ secrets.EC2_HOST }}:8888/" > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ API: ì •ìƒ"
              BACKEND_OK=true
              break
            else
              echo "â³ ë°±ì—”ë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/6)"
              sleep 10
            fi
          done
          
          # DuckDNS ì»¨í…Œì´ë„ˆ í™•ì¸
          if docker ps | grep hospital-duckdns > /dev/null; then
            echo "âœ… DuckDNS ìë™ ì—…ë°ì´íŠ¸: í™œì„±í™”"
            docker logs hospital-duckdns --tail=5
          else
            echo "âš ï¸ DuckDNS ìë™ ì—…ë°ì´íŠ¸: ë¹„í™œì„±í™”"
          fi
          
          # ìµœì¢… ê²°ê³¼ ì¶œë ¥
          echo ""
          echo "ğŸ‰ =========================================="
          echo "    ë°°í¬ ë° í—¬ìŠ¤ì²´í¬ ì™„ë£Œ!"
          echo "==========================================="
          echo ""
          echo "ğŸ“ ì ‘ì† ì •ë³´:"
          echo "  ğŸ”’ HTTPS: https://${{ secrets.DUCKDNS_DOMAIN }} (Let's Encrypt SSL)"
          echo "  ğŸŒ HTTP:  http://${{ secrets.DUCKDNS_DOMAIN }} (HTTPSë¡œ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸)"
          echo "  ğŸ”§ ë°±ì—”ë“œ API: http://${{ secrets.EC2_HOST }}:8888"
          echo ""
          echo "âœ¨ DuckDNS ìë™ IP ì—…ë°ì´íŠ¸ + Let's Encrypt SSL ì¸ì¦ì„œ!"
          
    - name: ë°ì´í„° ìˆ˜ì§‘ API ìë™ ì‹¤í–‰
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "ğŸ”„ ë³‘ì› API ë°ì´í„° ìë™ ìˆ˜ì§‘ ì‹œì‘..."
          
          # ë°±ì—”ë“œ ì„œë²„ê°€ ì™„ì „íˆ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          echo "â³ ë°±ì—”ë“œ ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          for i in {1..30}; do
            if curl -f -s --connect-timeout 5 "http://localhost:8888/" > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ ì„œë²„ ì¤€ë¹„ ì™„ë£Œ"
              break
            else
              echo "  ëŒ€ê¸° ì¤‘... ($i/30)"
              sleep 10
            fi
          done
          
          # ì¶”ê°€: API ì—”ë“œí¬ì¸íŠ¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          echo "ğŸ” API ì—”ë“œí¬ì¸íŠ¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸..."
          if curl -s -I "https://${{ secrets.DUCKDNS_DOMAIN }}:8888/api/pharmacy/save" | grep -q "HTTP"; then
            echo "âœ… pharmacy/save API ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ê°€ëŠ¥"
          else
            echo "âŒ pharmacy/save API ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ë¶ˆê°€ëŠ¥"
          fi
          
          if curl -s -I "https://${{ secrets.DUCKDNS_DOMAIN }}:8888/api/main/save" | grep -q "HTTP"; then
            echo "âœ… main/save API ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ê°€ëŠ¥"
          else
            echo "âŒ main/save API ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ë¶ˆê°€ëŠ¥"
            echo "ğŸ” ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸:"
            docker logs hospital-backend --tail=20
          fi
          
          # API í˜¸ì¶œ í•¨ìˆ˜
          call_api() {
            local api_endpoint="$1"
            local description="$2"
            
            echo "ğŸš€ ì‹œì‘: $description ë°ì´í„° ìˆ˜ì§‘"
            echo "ğŸ“¡ API í˜¸ì¶œ: https://***:8888/$api_endpoint"
            
            # API í˜¸ì¶œ
            response=$(curl -s -w "%{http_code}" -X POST "https://${{ secrets.DUCKDNS_DOMAIN }}:8888/$api_endpoint" \
              -H "Content-Type: application/json" \
              --connect-timeout 30 \
              --max-time 300 \
              --verbose 2>&1)
            
            # HTTP ìƒíƒœ ì½”ë“œ ì¶”ì¶œ
            http_code="${response: -3}"
            response_body="${response%???}"
            
            if [[ "$http_code" == "200" || "$http_code" == "201" ]]; then
              echo "âœ… ì„±ê³µ: $description ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ (HTTP $http_code)"
              echo "ğŸ“‹ ì‘ë‹µ: ${response_body:0:100}..."
            else
              echo "âŒ ì‹¤íŒ¨: $description ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨ - HTTP $http_code"
              echo "ğŸ“‹ ì‘ë‹µ ë‚´ìš©: $response_body"
              return 1
            fi
            
            echo "ğŸ ì™„ë£Œ: $description ë°ì´í„° ìˆ˜ì§‘"
            echo "----------------------------------------"
            
            # ë‹¤ìŒ API í˜¸ì¶œ ì „ ëŒ€ê¸° (ì„œë²„ ë¶€í•˜ ë°©ì§€)
            sleep 3
          }
          
          echo "=========================================="
          echo "ğŸ¥ ë³‘ì› API ë°ì´í„° ìë™ ìˆ˜ì§‘ í”„ë¡œì„¸ìŠ¤ ì‹œì‘"
          echo "=========================================="
          
          # ìˆœì°¨ì  API í˜¸ì¶œ
          if call_api "api/pharmacy/save" "ì•½êµ­"; then
            if call_api "api/main/save" "ë³‘ì› ê¸°ë³¸ì •ë³´"; then
              if call_api "api/details/save" "ë³‘ì› ìƒì„¸ì •ë³´"; then
                if call_api "api/subject/save" "ì§„ë£Œê³¼ëª©"; then
                  if call_api "api/proDoc/save" "ì „ë¬¸ì˜"; then
                    echo "=========================================="
                    echo "ğŸ‰ ëª¨ë“  API ë°ì´í„° ìˆ˜ì§‘ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
                    echo "ğŸ“Š ìˆ˜ì§‘ ì™„ë£Œëœ ë°ì´í„°:"
                    echo "  âœ… 1. ì•½êµ­ ë°ì´í„°"
                    echo "  âœ… 2. ë³‘ì› ê¸°ë³¸ì •ë³´ ë°ì´í„°"
                    echo "  âœ… 3. ë³‘ì› ìƒì„¸ì •ë³´ ë°ì´í„°"
                    echo "  âœ… 4. ì§„ë£Œê³¼ëª© ë°ì´í„°"
                    echo "  âœ… 5. ì „ë¬¸ì˜ ë°ì´í„°"
                    echo "=========================================="
                  else
                    echo "âŒ ì „ë¬¸ì˜ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
                    exit 1
                  fi
                else
                  echo "âŒ ì§„ë£Œê³¼ëª© ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
                  exit 1
                fi
              else
                echo "âŒ ë³‘ì› ìƒì„¸ì •ë³´ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
                exit 1
              fi
            else
              echo "âŒ ë³‘ì› ê¸°ë³¸ì •ë³´ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
              exit 1
            fi
          else
            echo "âŒ ì•½êµ­ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
            exit 1
          fi
          
    - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì²˜ë¦¬
      if: failure()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨! ë¡¤ë°± ì‹œë„..."
          
          # ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          docker-compose -f /home/ec2-user/docker-compose.prod.yml down || true
          
          # ìµœê·¼ ë¡œê·¸ í™•ì¸
          echo "ğŸ“ ìµœê·¼ ë¡œê·¸:"
          docker-compose -f /home/ec2-user/docker-compose.prod.yml logs --tail=50
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /home/ec2-user/*.tar.gz
          
          echo "ğŸ”„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
