name: EC2 배포 (DuckDNS) 

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}

jobs:
  build-and-deploy:
    name: 빌드 및 배포
    runs-on: ubuntu-latest
    
    steps:
    - name: 소스코드 체크아웃
      uses: actions/checkout@v3
      
    - name: Docker Buildx 설정
      uses: docker/setup-buildx-action@v2
      
    - name: 백엔드 도커 이미지 빌드
      run: |
        cd hospital_main
        echo "🔨 백엔드 Docker 이미지 빌드 중..."
        docker build --no-cache -t hospital-backend:${{ github.sha }} .
        docker tag hospital-backend:${{ github.sha }} hospital-backend:latest
        echo "✅ 백엔드 이미지 생성 완료"
        
    - name: 도커 이미지 압축 및 저장
      run: |
        echo "💾 Docker 이미지 압축 중..."
        docker save hospital-backend:latest | gzip > backend.tar.gz
        
        # 이미지 크기 확인
        ls -lh *.tar.gz
        echo "✅ 이미지 압축 완료"
        
    - name: 배포 파일들을 EC2 서버로 전송
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "backend.tar.gz,docker-compose.prod.yml,deploy.sh"
        target: "/home/ec2-user/"

    - name: EC2 서버 시스템 업데이트 및 필수 도구 설치 (프로덕션)
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "🔄 프로덕션 서버 시스템 업데이트 및 필수 도구 설치 시작..."
          
          # 시스템 업데이트
          echo "📦 시스템 패키지 업데이트 중..."
          sudo yum update -y
          
          # 기본 패키지 설치
          sudo yum install -y wget curl git unzip htop
          
          # Docker 설치 확인 및 설치
          if ! command -v docker &> /dev/null; then
            echo "🐳 Docker 설치 중..."
            sudo yum install -y docker
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -a -G docker ec2-user
            echo "✅ Docker 설치 완료"
          else
            echo "✅ Docker 이미 설치됨"
            docker --version
          fi
          
          # Docker Compose 설치 확인 및 설치
          if ! command -v docker-compose &> /dev/null; then
            echo "🔧 Docker Compose 설치 중..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
            echo "✅ Docker Compose 설치 완료"
          else
            echo "✅ Docker Compose 이미 설치됨"
            docker-compose --version
          fi
          
          # 프로덕션 모니터링 도구 디렉토리 생성
          sudo mkdir -p /opt/monitoring/{grafana,prometheus,loki}
          sudo chown -R ec2-user:ec2-user /opt/monitoring/
          
          # Grafana 설치 확인 및 설치 (프로덕션)
          if ! systemctl is-active --quiet grafana-server; then
            echo "📊 Grafana 설치 중... (프로덕션)"
            sudo yum install -y https://dl.grafana.com/oss/release/grafana-10.2.2-1.x86_64.rpm
            sudo systemctl daemon-reload
            sudo systemctl enable grafana-server
            sudo systemctl start grafana-server
            
            # Grafana 보안 설정 (프로덕션용)
            sudo mkdir -p /etc/grafana/provisioning/dashboards
            sudo mkdir -p /etc/grafana/provisioning/datasources
            
            echo "✅ Grafana 설치 완료 (포트: 3000)"
          else
            echo "✅ Grafana 이미 실행 중"
          fi
          
          # Prometheus 설치 확인 및 설치 (프로덕션)
          if [ ! -d "/opt/prometheus" ]; then
            echo "📈 Prometheus 설치 중... (프로덕션)"
            cd /tmp
            wget https://github.com/prometheus/prometheus/releases/download/v2.47.2/prometheus-2.47.2.linux-amd64.tar.gz
            tar xvfz prometheus-*.tar.gz
            sudo mv prometheus-2.47.2.linux-amd64 /opt/prometheus
            sudo chown -R ec2-user:ec2-user /opt/prometheus
            
            # Prometheus 프로덕션 설정 파일 생성
            cat > /opt/prometheus/prometheus.yml << EOF
          global:
            scrape_interval: 15s
            evaluation_interval: 15s
            external_labels:
              environment: 'production'
              cluster: 'hospital-main'
          
          rule_files:
            # - "alert_rules.yml"
          
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
              scrape_interval: 30s
            
            - job_name: 'hospital-backend-prod'
              static_configs:
                - targets: ['localhost:8888']
              metrics_path: '/actuator/prometheus'
              scrape_interval: 10s
              scrape_timeout: 10s
            
            - job_name: 'hospital-mariadb'
              static_configs:
                - targets: ['localhost:3500']
              scrape_interval: 30s
          
            - job_name: 'node-exporter'
              static_configs:
                - targets: ['localhost:9100']
              scrape_interval: 15s
          EOF
            
            # Prometheus 프로덕션 서비스 파일 생성
            sudo tee /etc/systemd/system/prometheus.service > /dev/null << EOF
          [Unit]
          Description=Prometheus Server (Production)
          Documentation=https://prometheus.io/docs/
          After=network-online.target
          
          [Service]
          User=ec2-user
          Restart=on-failure
          RestartSec=5
          ExecStart=/opt/prometheus/prometheus \\
            --config.file=/opt/prometheus/prometheus.yml \\
            --storage.tsdb.path=/opt/prometheus/data \\
            --storage.tsdb.retention.time=30d \\
            --web.console.templates=/opt/prometheus/consoles \\
            --web.console.libraries=/opt/prometheus/console_libraries \\
            --web.listen-address=0.0.0.0:9090 \\
            --web.enable-lifecycle \\
            --web.enable-admin-api
          
          [Install]
          WantedBy=multi-user.target
          EOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable prometheus
            sudo systemctl start prometheus
            echo "✅ Prometheus 설치 완료 (포트: 9090)"
          else
            echo "✅ Prometheus 이미 설치됨"
          fi
          
          # Loki 설치 확인 및 설치 (프로덕션)
          if [ ! -d "/opt/loki" ]; then
            echo "📋 Loki 설치 중... (프로덕션)"
            cd /tmp
            wget https://github.com/grafana/loki/releases/download/v2.9.2/loki-linux-amd64.zip
            unzip loki-linux-amd64.zip
            sudo mkdir -p /opt/loki/{data,chunks,rules}
            sudo mv loki-linux-amd64 /opt/loki/loki
            sudo chmod +x /opt/loki/loki
            sudo chown -R ec2-user:ec2-user /opt/loki
            
            # Loki 프로덕션 설정 파일 생성
            cat > /opt/loki/loki-local-config.yaml << EOF
          auth_enabled: false
          
          server:
            http_listen_port: 3100
            grpc_listen_port: 9096
            log_level: info
          
          common:
            path_prefix: /opt/loki
            storage:
              filesystem:
                chunks_directory: /opt/loki/chunks
                rules_directory: /opt/loki/rules
            replication_factor: 1
            ring:
              instance_addr: 127.0.0.1
              kvstore:
                store: inmemory
          
          query_range:
            results_cache:
              cache:
                embedded_cache:
                  enabled: true
                  max_size_mb: 500
          
          schema_config:
            configs:
              - from: 2020-10-24
                store: boltdb-shipper
                object_store: filesystem
                schema: v11
                index:
                  prefix: index_
                  period: 24h
          
          limits_config:
            retention_period: 30d
            max_query_series: 100000
            max_query_parallelism: 32
          
          table_manager:
            retention_deletes_enabled: true
            retention_period: 30d
          
          ruler:
            alertmanager_url: http://localhost:9093
          EOF
            
            # Loki 프로덕션 서비스 파일 생성
            sudo tee /etc/systemd/system/loki.service > /dev/null << EOF
          [Unit]
          Description=Loki service (Production)
          After=network.target
          
          [Service]
          Type=simple
          User=ec2-user
          ExecStart=/opt/loki/loki -config.file /opt/loki/loki-local-config.yaml
          Restart=on-failure
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=loki
          
          [Install]
          WantedBy=multi-user.target
          EOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable loki
            sudo systemctl start loki
            echo "✅ Loki 설치 완료 (포트: 3100)"
          else
            echo "✅ Loki 이미 설치됨"
          fi
          
          # Promtail 설치 (프로덕션 로그 수집)
          if [ ! -f "/opt/loki/promtail" ]; then
            echo "📤 Promtail 설치 중... (프로덕션)"
            cd /tmp
            wget https://github.com/grafana/loki/releases/download/v2.9.2/promtail-linux-amd64.zip
            unzip promtail-linux-amd64.zip
            sudo mv promtail-linux-amd64 /opt/loki/promtail
            sudo chmod +x /opt/loki/promtail
            
            # Promtail 프로덕션 설정 파일 생성
            cat > /opt/loki/promtail-local-config.yaml << EOF
          server:
            http_listen_port: 9080
            grpc_listen_port: 0
          
          positions:
            filename: /opt/loki/positions.yaml
          
          clients:
            - url: http://localhost:3100/loki/api/v1/push
          
          scrape_configs:
            - job_name: system-logs
              static_configs:
                - targets:
                    - localhost
                  labels:
                    job: system
                    environment: production
                    __path__: /var/log/*log
            
            - job_name: docker-logs
              static_configs:
                - targets:
                    - localhost
                  labels:
                    job: docker
                    environment: production
                    __path__: /var/lib/docker/containers/*/*log
            
            - job_name: hospital-app-logs
              static_configs:
                - targets:
                    - localhost
                  labels:
                    job: hospital-backend
                    environment: production
                    __path__: /opt/hospital/logs/*.log
          EOF
            
            # Promtail 프로덕션 서비스 파일 생성
            sudo tee /etc/systemd/system/promtail.service > /dev/null << EOF
          [Unit]
          Description=Promtail service (Production)
          After=network.target
          
          [Service]
          Type=simple
          User=ec2-user
          ExecStart=/opt/loki/promtail -config.file /opt/loki/promtail-local-config.yaml
          Restart=on-failure
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=promtail
          
          [Install]
          WantedBy=multi-user.target
          EOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable promtail
            sudo systemctl start promtail
            echo "✅ Promtail 설치 완료 (포트: 9080)"
          fi
          
          # Node Exporter 설치 (시스템 메트릭 수집)
          if [ ! -f "/opt/node_exporter/node_exporter" ]; then
            echo "🖥️ Node Exporter 설치 중... (프로덕션)"
            cd /tmp
            wget https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz
            tar xvfz node_exporter-*.tar.gz
            sudo mkdir -p /opt/node_exporter
            sudo mv node_exporter-1.6.1.linux-amd64/node_exporter /opt/node_exporter/
            sudo chmod +x /opt/node_exporter/node_exporter
            sudo chown -R ec2-user:ec2-user /opt/node_exporter
            
            # Node Exporter 서비스 파일 생성
            sudo tee /etc/systemd/system/node_exporter.service > /dev/null << EOF
          [Unit]
          Description=Node Exporter
          After=network.target
          
          [Service]
          Type=simple
          User=ec2-user
          ExecStart=/opt/node_exporter/node_exporter --web.listen-address=:9100
          Restart=on-failure
          RestartSec=5
          
          [Install]
          WantedBy=multi-user.target
          EOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable node_exporter
            sudo systemctl start node_exporter
            echo "✅ Node Exporter 설치 완료 (포트: 9100)"
          fi
          
          # 서비스 상태 확인
          echo "🔍 프로덕션 서버 설치된 서비스 상태 확인:"
          echo "  Docker: $(sudo systemctl is-active docker)"
          echo "  Grafana: $(sudo systemctl is-active grafana-server)"
          echo "  Prometheus: $(sudo systemctl is-active prometheus)"
          echo "  Loki: $(sudo systemctl is-active loki)"
          echo "  Promtail: $(sudo systemctl is-active promtail)"
          echo "  Node Exporter: $(sudo systemctl is-active node_exporter)"
          
          echo "✅ 프로덕션 서버 시스템 업데이트 및 모니터링 도구 설치 완료!"
        
    - name: EC2 서버에 DuckDNS로 배포
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        envs: GITHUB_SHA
        script: |
          echo "🚀 병원 프로젝트 DuckDNS 배포 시작..."
          
          # Docker 이미지 로드
          echo "📦 Docker 이미지 로드 중..."
          docker load < /home/ec2-user/backend.tar.gz
          
          # 필요한 디렉토리 생성
          sudo mkdir -p /opt/hospital/config/duckdns
          sudo mkdir -p /opt/hospital/logs
          sudo chown -R ec2-user:ec2-user /opt/hospital/
          
          # .env 파일 생성
          cat > .env << EOF
          ENVIRONMENT=production
          IMAGE_TAG=latest
          
          # 데이터베이스 설정
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=3500
          
          # 백엔드 설정
          BACKEND_HOST=hospital-backend
          BACKEND_PORT=8888
          
          # DuckDNS 설정
          DUCKDNS_DOMAIN=${{ secrets.DUCKDNS_DOMAIN }}
          DUCKDNS_SUBDOMAIN=${{ secrets.DUCKDNS_SUBDOMAIN }}
          DUCKDNS_TOKEN=${{ secrets.DUCKDNS_TOKEN }}
          
          # 병원/약국 API 키 설정
          HOSPITAL_MAIN_API_KEY=${{ secrets.HOSPITAL_MAIN_API_KEY }}
          HOSPITAL_DETAIL_API_KEY=${{ secrets.HOSPITAL_DETAIL_API_KEY }}
          HOSPITAL_MEDICAL_SUBJECT_API_KEY=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_KEY }}
          HOSPITAL_PRODOC_API_KEY=${{ secrets.HOSPITAL_PRODOC_API_KEY }}
          HOSPITAL_PHARMACY_API_KEY=${{ secrets.HOSPITAL_PHARMACY_API_KEY }}
          HOSPITAL_EMERGENCY_API_KEY=${{ secrets.HOSPITAL_EMERGENCY_API_KEY }}
          API_ADMIN_KEY=${{ secrets.API_ADMIN_KEY }}
          
          # 병원/약국 API Base URL 설정
          HOSPITAL_MAIN_API_BASE_URL=${{ secrets.HOSPITAL_MAIN_API_BASE_URL }}
          HOSPITAL_DETAIL_API_BASE_URL=${{ secrets.HOSPITAL_DETAIL_API_BASE_URL }}
          HOSPITAL_MEDICAL_SUBJECT_API_BASE_URL=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_BASE_URL }}
          HOSPITAL_PRODOC_API_BASE_URL=${{ secrets.HOSPITAL_PRODOC_API_BASE_URL }}
          HOSPITAL_PHARMACY_API_BASE_URL=${{ secrets.HOSPITAL_PHARMACY_API_BASE_URL }}
          HOSPITAL_EMERGENCY_API_BASE_URL=${{ secrets.HOSPITAL_EMERGENCY_API_BASE_URL }}
          
          # 데이터베이스 설정
          DB_URL=${{ secrets.DB_URL }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          EOF
           
          # 환경변수 확인
          echo "📋 배포 환경 설정:"
          echo "  환경: production"
          echo "  DuckDNS 도메인: ${{ secrets.DUCKDNS_DOMAIN }}"
          echo "  DuckDNS 서브도메인: ${{ secrets.DUCKDNS_SUBDOMAIN }}"
          echo "  백엔드 포트: 8888"
          echo "  DB 포트: 3500"
          
          # 배포 스크립트 실행 권한 부여
          chmod +x /home/ec2-user/deploy.sh
          
          # 배포 실행
          echo "▶️ 배포 스크립트 실행..."
          /home/ec2-user/deploy.sh
          
          # 임시 파일 정리
          echo "🧹 임시 파일 정리..."
          rm -f /home/ec2-user/*.tar.gz
          
          echo "✅ 배포 완료!"
          
    - name: 서비스 상태 확인 및 헬스체크
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "🏥 프로덕션 서비스 헬스체크 시작..."
          
          # 컨테이너 상태 확인
          echo "📊 컨테이너 상태:"
          docker-compose -f /home/ec2-user/docker-compose.prod.yml ps
          
          # 모니터링 서비스 상태 확인
          echo "📈 모니터링 서비스 상태:"
          echo "  Grafana: $(sudo systemctl is-active grafana-server) - http://localhost:3000"
          echo "  Prometheus: $(sudo systemctl is-active prometheus) - http://localhost:9090"
          echo "  Loki: $(sudo systemctl is-active loki) - http://localhost:3100"
          echo "  Promtail: $(sudo systemctl is-active promtail) - http://localhost:9080"
          echo "  Node Exporter: $(sudo systemctl is-active node_exporter) - http://localhost:9100"
          
          # DuckDNS 도메인으로 백엔드 API 확인
          TARGET_URL="http://${{ secrets.DUCKDNS_DOMAIN }}:8888"
          echo "🔍 백엔드 API 응답 테스트 ($TARGET_URL)..."
          
          for i in {1..12}; do
            echo "  시도 $i/12..."
            
            if curl -f -s --connect-timeout 10 "$TARGET_URL/api/proDoc/status" > /dev/null 2>&1; then
              echo "✅ 백엔드 API: 정상"
              BACKEND_OK=true
              break
            else
              echo "⏳ 백엔드 시작 대기 중..."
              sleep 10
            fi
          done
          
          # 데이터베이스 연결 확인
          if docker ps | grep hospital-mariadb > /dev/null; then
            echo "✅ 데이터베이스: 정상"
          else
            echo "⚠️ 데이터베이스: 확인 필요"
          fi
          
          # DuckDNS 컨테이너 확인
          if docker ps | grep hospital-duckdns > /dev/null; then
            echo "✅ DuckDNS 자동 업데이트: 활성화"
            docker logs hospital-duckdns --tail=5
          else
            echo "⚠️ DuckDNS 자동 업데이트: 비활성화"
          fi
          
          # 최종 결과 출력
          echo ""
          echo "🎉 =========================================="
          echo "    프로덕션 배포 및 헬스체크 완료!"
          echo "==========================================="
          echo ""
          echo "📍 접속 정보:"
          echo "  🔧 백엔드 API: http://${{ secrets.DUCKDNS_DOMAIN }}:8888"
          echo "  🌍 DuckDNS 도메인: ${{ secrets.DUCKDNS_DOMAIN }}"
          echo "  📊 데이터베이스: 포트 3500 (내부 접근)"
          echo ""
          echo "📈 프로덕션 모니터링 대시보드:"
          echo "  📊 Grafana: http://${{ secrets.DUCKDNS_DOMAIN }}:3000 (admin/커스텀비밀번호)"
          echo "  📈 Prometheus: http://${{ secrets.DUCKDNS_DOMAIN }}:9090"
          echo "  📋 Loki: http://${{ secrets.DUCKDNS_DOMAIN }}:3100"
          echo "  🖥️ Node Exporter: http://${{ secrets.DUCKDNS_DOMAIN }}:9100/metrics"
          echo ""
          echo "🔧 API 테스트 예시:"
          echo "  curl http://${{ secrets.DUCKDNS_DOMAIN }}:8888/api/proDoc/status"
          echo "  curl http://${{ secrets.DUCKDNS_DOMAIN }}:8888/api/list"
          echo ""
          echo "🚀 프로덕션 환경 DuckDNS 자동 IP 업데이트 및 모니터링이 준비되었습니다!"
          
    - name: 배포 실패 시 롤백 처리
      if: failure()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "❌ 프로덕션 배포 실패! 롤백 시도..."
          
          # 컨테이너 중지
          docker-compose -f /home/ec2-user/docker-compose.prod.yml down || true
          
          # 최근 로그 확인
          echo "📝 최근 로그:"
          docker-compose -f /home/ec2-user/docker-compose.prod.yml logs --tail=50
          
          # 임시 파일 정리
          rm -f /home/ec2-user/*.tar.gz
          
          echo "🔄 이전 버전으로 롤백하거나 수동으로 문제를 해결하세요."
