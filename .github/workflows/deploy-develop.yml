name: EC2 ë°°í¬ (DuckDNS) - Develop

on:
  push:
    branches: [ Develop ]
  workflow_dispatch:

env:
  # ê°œë°œ í™˜ê²½ìš© í™˜ê²½ë³€ìˆ˜
  EC2_HOST: ${{ secrets.DEV_EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}

jobs:
  build-and-deploy:
    name: ë¹Œë“œ ë° ë°°í¬ (ê°œë°œí™˜ê²½)
    runs-on: ubuntu-latest
    
    steps:
    - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
      
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v2
      
    # ë””ë²„ê¹…ì„ ìœ„í•œ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
    - name: ë””ë ‰í† ë¦¬ êµ¬ì¡° ë° í•„ìš” íŒŒì¼ í™•ì¸
      run: |
        echo "ğŸ” í˜„ì¬ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
        ls -la
        echo ""
        echo "ğŸ” hospital_main ë””ë ‰í† ë¦¬ í™•ì¸:"
        if [ -d "hospital_main" ]; then
          ls -la hospital_main/
          echo "âœ… hospital_main ë””ë ‰í† ë¦¬ ì¡´ì¬"
        else
          echo "âŒ hospital_main ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        echo ""
        echo "ğŸ” í•„ìš”í•œ íŒŒì¼ë“¤ í™•ì¸:"
        required_files=("docker-compose.yml" "deploy-dev.sh" "hospital_main/Dockerfile")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file ì¡´ì¬"
          else
            echo "âŒ $file ëˆ„ë½!"
            exit 1
          fi
        done
        
    - name: ë°±ì—”ë“œ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        cd hospital_main
        echo "ğŸ”¨ ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘... (ê°œë°œí™˜ê²½)"
        
        # Dockerfile ì¡´ì¬ í™•ì¸
        if [ ! -f "Dockerfile" ]; then
          echo "âŒ Dockerfileì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        # ë¹Œë“œ ì‹œ ë” ìì„¸í•œ ë¡œê·¸ ì¶œë ¥
        docker build --no-cache --progress=plain -t hospital-backend-dev:${{ github.sha }} . 2>&1 | tee build.log
        
        # ë¹Œë“œ ê²°ê³¼ í™•ì¸
        if [ $? -eq 0 ]; then
          docker tag hospital-backend-dev:${{ github.sha }} hospital-backend-dev:latest
          echo "âœ… ë°±ì—”ë“œ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ (ê°œë°œí™˜ê²½)"
          docker images | grep hospital-backend-dev
        else
          echo "âŒ Docker ë¹Œë“œ ì‹¤íŒ¨!"
          echo "ë¹Œë“œ ë¡œê·¸:"
          cat build.log
          exit 1
        fi
        
    - name: ë„ì»¤ ì´ë¯¸ì§€ ì••ì¶• ë° ì €ì¥
      run: |
        echo "ğŸ’¾ Docker ì´ë¯¸ì§€ ì••ì¶• ì¤‘..."
        
        # ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
        if docker images | grep -q hospital-backend-dev:latest; then
          docker save hospital-backend-dev:latest | gzip > backend-dev.tar.gz
          
          # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
          ls -lh *.tar.gz
          echo "âœ… ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ"
        else
          echo "âŒ hospital-backend-dev:latest ì´ë¯¸ì§€ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
          docker images
          exit 1
        fi
        
    - name: ì „ì†¡í•  íŒŒì¼ë“¤ ì¡´ì¬ í™•ì¸
      run: |
        echo "ğŸ“‹ ì „ì†¡í•  íŒŒì¼ë“¤ í™•ì¸:"
        required_files=("backend-dev.tar.gz" "docker-compose.yml" "deploy-dev.sh")
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file ì¡´ì¬ ($(ls -lh $file | awk '{print $5}'))"
          else
            echo "âŒ $file ëˆ„ë½!"
            exit 1
          fi
        done
        
    - name: ë°°í¬ íŒŒì¼ë“¤ì„ EC2 ì„œë²„ë¡œ ì „ì†¡
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.DEV_EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "backend-dev.tar.gz,docker-compose.yml,deploy-dev.sh"
        target: "/home/ec2-user/"
        timeout: 300s

    - name: EC2 ì„œë²„ ê¸°ë³¸ í™˜ê²½ í™•ì¸ ë° ì„¤ì •
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.DEV_EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        timeout: 300s
        script: |
          echo "ğŸ” ê¸°ë³¸ í™˜ê²½ í™•ì¸..."
          
          # ì „ì†¡ëœ íŒŒì¼ë“¤ í™•ì¸
          echo "ğŸ“‹ ì „ì†¡ëœ íŒŒì¼ í™•ì¸:"
          ls -la /home/ec2-user/
          
          # Docker ì„¤ì¹˜ í™•ì¸
          if ! command -v docker &> /dev/null; then
            echo "ğŸ“¦ Docker ì„¤ì¹˜ ì¤‘..."
            sudo yum update -y
            sudo yum install -y docker
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -a -G docker ec2-user
            echo "âœ… Docker ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âœ… Docker ì´ë¯¸ ì„¤ì¹˜ë¨: $(docker --version)"
          fi
          
          # Docker Compose ì„¤ì¹˜ í™•ì¸
          if ! command -v docker-compose &> /dev/null; then
            echo "ğŸ“¦ Docker Compose ì„¤ì¹˜ ì¤‘..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            echo "âœ… Docker Compose ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âœ… Docker Compose ì´ë¯¸ ì„¤ì¹˜ë¨: $(docker-compose --version)"
          fi
        
    - name: EC2 ì„œë²„ì— DuckDNSë¡œ ë°°í¬ (ê°œë°œí™˜ê²½)
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.DEV_EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        envs: GITHUB_SHA
        timeout: 300s
        script: |
          echo "ğŸš€ ë³‘ì› í”„ë¡œì íŠ¸ DuckDNS ë°°í¬ ì‹œì‘... (ê°œë°œí™˜ê²½)"
          
          # í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸
          required_files=("/home/ec2-user/backend-dev.tar.gz" "/home/ec2-user/docker-compose.yml" "/home/ec2-user/deploy-dev.sh")
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file ì¡´ì¬"
            else
              echo "âŒ $file ëˆ„ë½!"
              exit 1
            fi
          done
          
          # Docker ì´ë¯¸ì§€ ë¡œë“œ
          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
          if docker load < /home/ec2-user/backend-dev.tar.gz; then
            echo "âœ… Docker ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ"
            docker images | grep hospital-backend-dev
          else
            echo "âŒ Docker ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          fi
          
          # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
          sudo mkdir -p /opt/hospital/config/duckdns
          sudo chown -R ec2-user:ec2-user /opt/hospital/
          
          # .env íŒŒì¼ ìƒì„± (ê°œë°œí™˜ê²½) - ì¤‘ë³µ ì œê±°
          cat > .env << EOF
          ENVIRONMENT=development
          IMAGE_TAG=latest
          
          # ë°±ì—”ë“œ ì„¤ì •
          BACKEND_HOST=hospital-backend-dev
          BACKEND_PORT=8888
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=3501
          DB_URL=${{ secrets.DB_URL }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          
          # DuckDNS ì„¤ì • (ê°œë°œí™˜ê²½)
          DUCKDNS_DOMAIN=${{ secrets.DEV_DUCKDNS_DOMAIN }}
          DUCKDNS_SUBDOMAIN=${{ secrets.DEV_DUCKDNS_SUBDOMAIN }}
          DUCKDNS_TOKEN=${{ secrets.DUCKDNS_TOKEN }}
          
          # ë³‘ì›/ì•½êµ­ API í‚¤ ì„¤ì •
          HOSPITAL_MAIN_API_KEY=${{ secrets.HOSPITAL_MAIN_API_KEY }}
          HOSPITAL_DETAIL_API_KEY=${{ secrets.HOSPITAL_DETAIL_API_KEY }}
          HOSPITAL_MEDICAL_SUBJECT_API_KEY=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_KEY }}
          HOSPITAL_PRODOC_API_KEY=${{ secrets.HOSPITAL_PRODOC_API_KEY }}
          HOSPITAL_PHARMACY_API_KEY=${{ secrets.HOSPITAL_PHARMACY_API_KEY }}
          HOSPITAL_EMERGENCY_API_KEY=${{ secrets.HOSPITAL_EMERGENCY_API_KEY }}
          API_ADMIN_KEY=${{ secrets.API_ADMIN_KEY }}
          
          # ë³‘ì›/ì•½êµ­ API Base URL ì„¤ì •
          HOSPITAL_MAIN_API_BASE_URL=${{ secrets.HOSPITAL_MAIN_API_BASE_URL }}
          HOSPITAL_DETAIL_API_BASE_URL=${{ secrets.HOSPITAL_DETAIL_API_BASE_URL }}
          HOSPITAL_MEDICAL_SUBJECT_API_BASE_URL=${{ secrets.HOSPITAL_MEDICAL_SUBJECT_API_BASE_URL }}
          HOSPITAL_PRODOC_API_BASE_URL=${{ secrets.HOSPITAL_PRODOC_API_BASE_URL }}
          HOSPITAL_PHARMACY_API_BASE_URL=${{ secrets.HOSPITAL_PHARMACY_API_BASE_URL }}
          HOSPITAL_EMERGENCY_API_BASE_URL=${{ secrets.HOSPITAL_EMERGENCY_API_BASE_URL }}
          
          EOF
           
          # í™˜ê²½ë³€ìˆ˜ í™•ì¸
          echo "ğŸ“‹ ë°°í¬ í™˜ê²½ ì„¤ì •:"
          echo "  í™˜ê²½: development"
          echo "  DuckDNS ë„ë©”ì¸: ${{ secrets.DEV_DUCKDNS_DOMAIN }}"
          echo "  DuckDNS ì„œë¸Œë„ë©”ì¸: ${{ secrets.DEV_DUCKDNS_SUBDOMAIN }}"
          echo "  ë°±ì—”ë“œ í¬íŠ¸: 8888"
          echo "  DB í¬íŠ¸: 3501"
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° ë‚´ìš© í™•ì¸
          chmod +x /home/ec2-user/deploy-dev.sh
          
          # ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš© ì¼ë¶€ í™•ì¸ (ë””ë²„ê¹…ìš©)
          echo "ğŸ“ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì²« 10ì¤„:"
          head -10 /home/ec2-user/deploy-dev.sh
          
          # ë°°í¬ ì‹¤í–‰
          echo "â–¶ï¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
          if /home/ec2-user/deploy-dev.sh; then
            echo "âœ… ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì„±ê³µ"
          else
            echo "âŒ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨"
            exit 1
          fi
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬..."
          rm -f /home/ec2-user/backend-dev.tar.gz
          
          echo "âœ… ê°œë°œí™˜ê²½ ë°°í¬ ì™„ë£Œ!"
          
    - name: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ë° í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.DEV_EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        timeout: 180s
        script: |
          echo "ğŸ¥ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì‹œì‘... (ê°œë°œí™˜ê²½)"
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ (ì˜¬ë°”ë¥¸ íŒŒì¼ëª… ì‚¬ìš©)
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          if [ -f /home/ec2-user/docker-compose.yml ]; then
            docker-compose -f /home/ec2-user/docker-compose.yml ps
          else
            echo "âŒ docker-compose.yml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            docker ps
          fi
          
          # DuckDNS ë„ë©”ì¸ìœ¼ë¡œ ë°±ì—”ë“œ API í™•ì¸
          TARGET_URL="http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:8888"
          echo "ğŸ” ë°±ì—”ë“œ API ì‘ë‹µ í…ŒìŠ¤íŠ¸ ($TARGET_URL)..."
          
          BACKEND_OK=false
          for i in {1..12}; do
            echo "  ì‹œë„ $i/12..."
            
            if curl -f -s --connect-timeout 10 "$TARGET_URL/api/proDoc/status" > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ API: ì •ìƒ"
              BACKEND_OK=true
              break
            else
              echo "â³ ë°±ì—”ë“œ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
              sleep 10
            fi
          done
          
          if [ "$BACKEND_OK" = false ]; then
            echo "âš ï¸ ë°±ì—”ë“œ API ì‘ë‹µ í™•ì¸ ì‹¤íŒ¨"
          fi
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
          if docker ps | grep hospital-mariadb > /dev/null; then
            echo "âœ… ë°ì´í„°ë² ì´ìŠ¤: ì •ìƒ"
          else
            echo "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤: í™•ì¸ í•„ìš”"
          fi
          
          # DuckDNS ì»¨í…Œì´ë„ˆ í™•ì¸
          if docker ps | grep hospital-duckdns > /dev/null; then
            echo "âœ… DuckDNS ìë™ ì—…ë°ì´íŠ¸: í™œì„±í™”"
            docker logs $(docker ps --filter "name=hospital-duckdns" --format "{{.Names}}") --tail=5
          else
            echo "âš ï¸ DuckDNS ìë™ ì—…ë°ì´íŠ¸: ë¹„í™œì„±í™”"
          fi
          
          # ìµœì¢… ê²°ê³¼ ì¶œë ¥
          echo ""
          echo "ğŸ‰ =========================================="
          echo "    ê°œë°œí™˜ê²½ ë°°í¬ ë° í—¬ìŠ¤ì²´í¬ ì™„ë£Œ!"
          echo "==========================================="
          echo ""
          echo "ğŸ“ ì ‘ì† ì •ë³´:"
          echo "  ğŸ”§ ë°±ì—”ë“œ API: http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:8888"
          echo "  ğŸŒ DuckDNS ë„ë©”ì¸: ${{ secrets.DEV_DUCKDNS_DOMAIN }}"
          echo "  ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤: í¬íŠ¸ 3501 (ë‚´ë¶€ ì ‘ê·¼)"
          echo ""
          echo "ğŸ”§ API í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ:"
          echo "  curl http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:8888/api/proDoc/status"
          echo "  curl http://${{ secrets.DEV_DUCKDNS_DOMAIN }}:8888/api/list"
          echo ""
          echo "âœ¨ ê°œë°œí™˜ê²½ DuckDNS ìë™ IP ì—…ë°ì´íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!"
          
    - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì²˜ë¦¬
      if: failure()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.DEV_EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "âŒ ê°œë°œí™˜ê²½ ë°°í¬ ì‹¤íŒ¨! ë¡¤ë°± ì‹œë„..."
          
          # ì»¨í…Œì´ë„ˆ ì¤‘ì§€ (ì˜¬ë°”ë¥¸ íŒŒì¼ëª… ì‚¬ìš©)
          docker-compose -f /home/ec2-user/docker-compose.yml down || true
          
          # ìµœê·¼ ë¡œê·¸ í™•ì¸
          echo "ğŸ“ ìµœê·¼ ë¡œê·¸:"
          docker-compose -f /home/ec2-user/docker-compose.yml logs --tail=50 || true
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /home/ec2-user/*.tar.gz
          
          echo "ğŸ”„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
